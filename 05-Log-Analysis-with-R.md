# Log Analysis with R

This is a guide to setting up [R] to analyze the `.log` files generated by [HOOMD-blue] colloids simulations in the [PRoPS Group].

This guide is optimized for MacOS. See [Simulating waterDPD](/02-Simulating-waterDPD.md) for help running colloids simulations with HOOMD-blue.

[Last Update: August 2021]

Our R workflow was developed by Mohammad (Nabi) Nabizadeh. This guide was compiled by Rob Campbell.

[R]: https://www.r-project.org/
[HOOMD-blue]: http://glotzerlab.engin.umich.edu/hoomd-blue/
[PRoPS Group]: https://web.northeastern.edu/complexfluids/
<br>

## Why Choose R

To analyze the `.log` file genearted by a HOOMD-blue colloids simulation we will primarily be plotting the numbers stored in the file. This can easily be done in R, Python, MATLAB, or other software and programming languages, but the quality of plotting option in R, and it's versatility and ease of use for statistical analysis, makes it by far the best choice (even if the syntax can take a little while to get used to).
<br>
<br>
## Getting and Installing R, RStudio, and the Tidyverse

You can install R directly from the [R Project website](https://www.r-project.org/) by downloading from a CRAN mirror (to get automatically redirected to the closest available mirror, use the "0-Cloud" link)<br>
*Note: If you are downloading for MacOS there are two releases of the latest version of R, one for Intel-based computers and one for computers with Apple silicon (ARM processors). Be sure to choose the correct version for your needs.*

Once you have installed R you should install RStudio from the RStudio website, by choosing the [free desktop version](https://www.rstudio.com/products/rstudio/download/#download)<br>
*Note: The website should automatically detect your operating system and give you the correct download link.*

For getting started with R, it is recommended that you install the [tidyverse](https://www.tidyverse.org/) collection of packages designed for data science. You can do this in RStudio by going to the Console and running
```console
> install.packages("tidyverse")
```

You are now ready to use R!

**Pro Tip**: Got to "RStudio" on the MacOS Menu Bar and select "Preferences..." to open the Options window. Select "Code" from the sidebar. On the "Display" tab you can check a box to turn on "Rainbow parentheses." This will change the color of nested parentheses to a ROYGBIV order, so that the outermost are red and the innermost are purple. This can make it easier to keep track of nested parentheses and avoid parentheses-related errors.

If you would like to modify the appearance of RStudio further, go to "Appearance" in the sidebar of the Options window to change the overall "RStudio theme", adjust the font and font size, and/or change your "Editor theme" to match your color preferences (or to match another IDE, such as "Eclipse").
<br>
<br>
## The RStudio Console

RStudio has 4 main sections
1. [top-left] A new or existing file, where you write your R scripts. *This will only be visible if you have a file open.*
2. [bottom-left] A Console, Terminal, and Jobs manager. You can use the Console for basic math, to run R commands separate from a full script, etc. The Console will also display the status of executed code from an R script file.
3. [top-right] A list of data sets loaded into the Environment, as well as History, Connections, and Tutorial tabs.
4. [bottom-right] A Files viewer, Plots, available Packages, Help, and general Viewer.

To get started we will write our code in a file in the top-left, view information about executed code in the Console at the bottom-left, and view Plots in the bottom-right.
<br>
<br>
## Creating a New R Script

Go to the "File" menu on the MacOS Menu Bar, and select "New File," "R Script"
<br>
<br>
## Loading and Checking Data

In the R Script, create a data frame named "P" to read the `Pressure_xy.log` file (or another `.log` file of your choice)
```r
P.df = read.table(file = "~/file_location", header = T)
```
*Note: when entering the file location, you can use the "tab" key to view available file path options and autocomplete with "return")*

 With the cursor on this line, hold the "command" key and hit "return" to load the file. 

Now that the file is loaded, we should check the first few lines to understand the formatting. In the R script type
```r
head(P.df)
```
and then command+return.

In the Console section [bottom-left] you will see the line of code that you executed, and the first 6 lines of the file (your values for `pressure_xy` and `temperature` will vary with your simulation)
```console
> head(P.df)
  timestep pressure_xy temperature
1        0  0.11098247  0.00000000
2        1  0.10851238  0.02589183
3        2  0.10361774  0.09799322
4        3  0.09769909  0.20621219
5        4  0.08895702  0.34156559
6        5  0.07994112  0.49465869
```
We can see that the file has 3 columns of data, and the first line in each column is not a data point, it's the label for that column.

In addition to viewing the head of a file it is good to get a summary overview of the full data set. This can help you catch any weird things that might have happened (e.g. if temperature was set to 1 but reaches 1000, or if any basic statistical analyses give you an "N/A" value instead of a number).
Back in the R script, add
```r
summary(P.df)
```
and command+enter to run it.

The Console should display something like:
```console
> summary(P.df)
    timestep      pressure_xy         temperature    
 Min.   :  0.0   Min.   :-0.121535   Min.   :0.0000  
 1st Qu.:249.8   1st Qu.:-0.038633   1st Qu.:0.1051  
 Median :499.5   Median :-0.013924   Median :0.1204  
 Mean   :499.5   Mean   :-0.016007   Mean   :0.2323  
 3rd Qu.:749.2   3rd Qu.: 0.002718   3rd Qu.:0.2157  
 Max.   :999.0   Max.   : 0.110982   Max.   :1.6282 
```
You can see there are 1000 timesteps (0-99), the pressure ranges from approximately -0.1 to 0.1, and the termperature ranges from 0 to about 1. All looks good!

Another way to check the data is to view the full data set in a table (similar to an Excel sheet). <br>
In the R script add
```r
View(P.df)
```
and command+enter. This creates a new file with the data displayed as a table. This file will open as a new tab in the top-left section (temporarily hiding the R script from view).
<br>
<br>
## Plotting Data

Go back to the R Script file and let's plot the data!

Start with temperature vs. time. We already loaded each column of the data from `Pressure_xy.log` into the dataframe `P.df`, so we can assign those variables to the x and y axes with `P.df$variable-name`:
```r
plot(x = P.df$timestep, y = P.df$temperature, xlab = "Time", ylab = "Temperature")
```
The attributes `xlab` and `ylab` set the x-axis label and y-axis label, respectively.

Command+enter to plot the data. The command will be executed in the Console, and when it finishes running, the plot will appear in the bottom-right section.

You'll see that the temperature briefly spikes above 1.5 before dropping and stabilizing around 0.1. 

Go ahead and view the `waterDPD.py` script. Either open the file with your preferred IDE, or open a Temrinal window alongside R Studio and 
```bash
$ vim /repositories/HOOMDblue/sims/water/waterDPD.py
```
Looking at the "INPUTS" you can see that we set the temperature to 0.1 (i.e. `KT=.1`). In the simulation the temperature shoots up, as the particles start moving, but it goes back down to 0.1 because of the dissipative force (i.e. viscosity) in our dissipative particle dynamics (DPD) model. The dissipative force takes away the extra energy from the initiated particle motion, and the simulation stabilizes to equilibrium conditions. This is an important first step for all our simulations.

Check to see if it really does go to 0.1 by adding a red dashed line at 0.1:
```r
lines(x = c(-100, 2000), y = c(0.1, 0.1), lty=2, col='red', lwd=2)
```

Now check another parameter: pressure vs. time
```r
plot(x = P.df$timestep, y = P.df$pressure, xlab = "Time", ylab = "Pressure")
lines(x = c(-100, 2000), y = c(0, 0), lty=2, col='red', lwd=2)
```
This should start noisy but eventually even out to an oscillation around 0.

Remember that we're plotting something more specific than just "pressure." Pressure is a tensor with multiple directions, and if you look back at `waterDPD.py` you'll remember that we specifically chose in `hoomd.analyze` to log the pressure in the x-y direction. This was chosen so that we could eventually look at shear stress (tau = -P), but there's no shear yet. The first step is to bring the simulation to equilibrium, which is all that `waterDPD.py` currently does. At equilibrium the pressure should oscillates around 0 (in our case, between -0.5 and 0.5).

You can also check this by looking back at `summary(P.df)`. The average pressure is indeed close to 0 (our example is -0.016007). If you run the simulation for longer, say 10,000 timesteps, you should get much closer to 0.
<br>
<br>
## Analyzing `.log` Files While Running Simulations

You can also use R to track a simulation's progress as it runs.

Let's check the simulation again: Does the temperature remain at 0.1 and the pressure average at 0 for longer timesteps?

Go back to `waterDPD.py` and increase the runtime by changing `N_time_steps` to 10,000. Then source to VirtEnv and run the simulation (see [Running a Simulation](../02-Simulating-waterDPD.md#running-a-simulation) in Simulating waterDPD.py for full steps).

While the simulation runs, go back to RStudio and in the R script add
```r
nrow(P.df)
```
and command+enter to run it. 

You should see the current numebr of lines displayed in the Console. You can execute this command again and watch the number of lines increase towards 10,000 as the simulation runs.

You can also replot the temperature plot and the pressure plot while the simulation is running. This will only plot the amount of data that has been logged at the time you run the command, but you can continue to update the plots as the simulation finishes.

Is temperature conserved? Does pressure go to zero?
<br>
<br>
## The Importance of Temperature

Typically when running a simulation in HOOMD-blue you will want to output a `.gsd` file for visualization and a `.log` of temperature and pressure. Temperature is necessary to track for a variety of reasons, but **most importantly** because we are running a dissipative particle dynamics (DPD) simulation. 

***Always check that temperature is conserved to verify that the DPD simulation is running properly.***

A working DPD simulation will maintain a steady temperature around the value we set for KT. If temperature is not conserved, that is a sign that the simulation is not running properly.

Temperature is conserved by the dissipative force, which you can modify with gamma (which determines viscosity, to some extent). A larger gamma value means a stronger dissipative force, which means the DPD simulation will be better at dissipating extra energy. If gamma is too high, too much energy will dissipate for the simulation to accurately represent particle interactions; but, if gamma is too low, the system will not equillibriate.

To test this, go back to `waterDPD.py` and lower gamma significantly (gamma=0.1) and rerun the simulation. In RStudio, plot the temperature to see the results.

Even after 10,000 timesteps, the simulation should still struggle to get down to a temperature of 0.1. For this simulation with a gamma this low, it probably needs 30,000-40,000 timesteps to stabilize. And remember, conserving temperature (to achieve equilibrium) is only the first step before simulating shear or anything else.

Rerunning the pressure plot should also show more instability with peaks easily reaching -0.1/0.1 in the later parts of the simulation.

This should help demonstrate how important it will be to find the right balance of values to enter into our simulations, to both accurately model a system and to minimize the time needed to complete a simulation.

***Typically you should use the diffusion time to estimate how long a simulation needs to be run to reach equilibrium (the standard is to run for 500 diffusion times).*** Some systems, like those with low-frequency vibrations, will probably equilibriate faster. Once you start working on a project you can usually find advice on these parameters in the literature specific to your system.



 

